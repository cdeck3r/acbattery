---
layout: post
title: ""
author: "cdeck3r"
---

## About

This project introduces an AC battery designed for integration with a photovoltaic (PV) power plant. 

The system is installed in a residential setting, specifically a single-family home. The PV power plant has a maximum output of 600W (installed PV panels have 800Wp), while the battery has a storage capacity of 1kWh.

The primary objective of this project is to optimize the use of energy generated by the PV power plant within the household. This is achieved by storing excess energy produced during daylight hours, making it available for consumption during the evening and nighttime.

## Motivation

Despite the relatively small scale of this setup, the integration of a battery increases energy utilization from 65% to 87%, while the payback period extends slightly from 4 years to 5 years. The annual savings, due to reduced electricity consumption, amount to approximately 191 EUR for the system with the battery, compared to 142 EUR without it. The total invest is 950 EUR.

All values were calculated using the [Stecker-Solar-Simulator](https://solar.htw-berlin.de/rechner/stecker-solar-simulator/) developed by HTW Berlin.


## Concept

The AC battery system comprises a lithium iron phosphate (LiFePo4) battery connected to an AC charger and an inverter. The accompanying diagram illustrates how these components are integrated into the grid, where both the charger and inverter rely on AC from the standard electricity supply, hence the term "AC battery."

![AC Battery Concept](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/cdeck3r/acbattery/main/plantuml/battery.plantuml)

However, the processes of converting AC to DC and back to AC are subject to efficiency losses, with each conversion having an efficiency factor of less than 1. As a result, the system experiences a net negative energy balance, meaning that more energy is consumed during charging than is subsequently recovered from the battery. The system compensates for this energy loss through the integration of a PV power plant, which is connected to the AC line and supplies excess energy when charging the battery. The following diagram depicts this configuration.

![AC Battery Concept with PV](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/cdeck3r/acbattery/main/plantuml/batterywithpv.plantuml)

When the PV system generates surplus energy, it is stored in the battery for later use. The stored energy can then be supplied to power outlets as needed. If the conversion processes are managed effectively, the overall energy balance can become positive.

## System Context

At a more conceptual level, the AC battery functions as a device for storing energy from the grid and subsequently feeding it back into the system. An external smart meter monitors the photovoltaic (PV) excess. When excess energy is detected, the battery's charger connects to the AC line to initiate charging. The charger disengages once the excess energy is no longer available. When the battery reaches full capacity or energy demand arises, the inverter connects to the AC line to discharge the stored energy. The following image illustrates the system context.

![AC Battery System Context](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/cdeck3r/acbattery/main/plantuml/systemcontext.plantuml)

The AC battery does not operate independently; rather, it is managed by battery management software hosted on a device within the same Wi-Fi network, to which both the AC battery and the smart meter are connected. The management software retrieves data from the smart meter and remotely controls the battery's charger and inverter based on the current energy conditions.

## Hardware Design

The schematics were designed with [QElectroTech](https://qelectrotech.org/). You can download the [ACBattery schematics]() in PDF format.

![schematics]()

### Networked Units

The AC battery incorporates networked embedded devices for controlling and monitoring its operation:

- **Shelly Plus 1PM**: A Wi-Fi-enabled relay that manages the AC power supply to both the charger and the inverter.
- **ESP32 NodeMCU**: A microcontroller that controls the MOSFET driver board to switch DC power to the inverter and retrieves the battery's State of Charge (SoC) from the shunt.

### Electrical and Thermal Characteristics

In the following, there are some measurements showing the AC battery's characteristics.

| Inverter                                     | 95% Efficiency |
| Step Up consumption with no load             | 2W             |
| Temp. Step Up (under load)                   | 38째C           |
| Inverter consumption under load, but no grid | 1.7W           |
| Temp. MOSFET (no heat sink)                  | 95째C           |
| Temp. MOSFET (with heat sink)                | 70째C           |
| Temp. MOSFET (with heat sink and fan)        | 58째C           |
 

## Software

The software design is structured as a set of communicating [state machines](https://en.wikipedia.org/wiki/Finite-state_machine) based on the [actor model](https://en.wikipedia.org/wiki/Actor_model)


![Communicating Actors](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/cdeck3r/acbattery/main/plantuml/actors.plantuml)

In this model, each actor is a state machine that maintains its own state. State transitions occur in response to events, which are received from other actors or the external environment.

The following subsections provide the design of the three primary actors.

### `bmsActor`



### `pvActor`


### `invDrvActor`


## Software Deployment

The following UML deployment diagram illustrates the distribution of various software components for the AC battery system, which are hosted across multiple Raspberry Pi devices.

[Deployed Software Components for the AC Battery System](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/cdeck3r/acbattery/main/plantuml/swdeployment.plantuml)

The AC battery system requires real-time power measurements from an electricity meter that monitors both AC loads and photovoltaic (PV) energy surplus. The [vzlogger](https://github.com/volkszaehler/vzlogger) software, installed on a Raspberry Pi, connects to the electricity meter using the [SML protocol](https://de.wikipedia.org/wiki/Smart_Message_Language). 

The system employs several networked controllers to operate relays that connect the AC network to the battery for charging and discharging purposes. Each controller includes its own web-based graphical user interface (WebGUI), allowing for manual control of individual components. This feature is primarily intended for developers.

The battery management actors operate within a Node-RED environment hosted on a Raspberry Pi-based home server. All devices are connected to a home Wi-Fi network and communicate using the [MQTT](https://en.wikipedia.org/wiki/MQTT) protocol to a broker running on the home server. 

A dashboard provides users with insights into the current operation of the system. Notably, there is no remote access available from outside the home network.

## Contact

If you are having any problems, any questions or suggestions, feel free to [file a GitHub issue](https://github.com/cdeck3r/acbattery/issues/new).


