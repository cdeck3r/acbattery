---
layout: post
title: "My title"
author: "cdeck3r"

carousels:
  - images: 
    - image: assets/img/acbattery01.jpg
    - image: assets/img/acbattery02.jpg
    - image: assets/img/acbattery03.jpg
    - image: assets/img/acbattery04.jpg
    - image: assets/img/acbattery05.jpg
---

## About

This project introduces an AC battery designed for integration with a photovoltaic (PV) power plant. 

{% include carousel.html height="80" unit="%" duration="7" number="1" %}

The system is installed in a residential setting, specifically a single-family home. The PV power plant has a maximum output of 600W (installed PV panels have 800Wp), while the battery has a storage capacity of 1kWh.

The primary objective of this project is to optimize the use of energy generated by the PV power plant within the household. This is achieved by storing excess energy produced during daylight hours, making it available for consumption during the evening and nighttime.

## Motivation

Despite the relatively small scale of this setup, the integration of a battery increases energy utilization from 65% to 87%, while the payback period extends slightly from 4 years to 5 years. The annual savings, due to reduced electricity consumption, amount to approximately 191 EUR for the system with the battery, compared to 142 EUR without it. 

The total investment for the system is 950 EUR, which includes the cost of the PV power plant and all hardware components for the AC battery system. A Google search indicates that this amount is comparable to the prices of similar commercially available products when discounts are considered. However, the DIY approach allows for more granular operational control and offers significant learning opportunities.

All values were calculated using the [Stecker-Solar-Simulator](https://solar.htw-berlin.de/rechner/stecker-solar-simulator/) developed by HTW Berlin.


## Concept

The AC battery system comprises a lithium iron phosphate (LiFePo4) battery connected to an AC charger and an inverter. The accompanying diagram illustrates how these components are integrated into the grid, where both the charger and inverter rely on AC from the standard electricity supply, hence the term "AC battery."

![AC Battery Concept](https://cdn-0.plantuml.com/plantuml/png/DSmn3i8m34RXlQU02yG36rEluZeMZN3SoFajnEq1YKvF-eQtJd0WkotNvc9PDSCkEp3cdIZuLHuDUsuvDUHmgAF8qKcgolCMnB8neF6cpirf6FllHdyj9oohUlts0m00)

However, the processes of converting AC to DC and back to AC are subject to efficiency losses, with each conversion having an efficiency factor of less than 1. As a result, the system experiences a net negative energy balance, meaning that more energy is consumed during charging than is subsequently recovered from the battery. The system compensates for this energy loss through the integration of a PV power plant, which is connected to the AC line and supplies excess energy when charging the battery. The following diagram depicts this configuration.

![AC Battery Concept with PV](https://cdn-0.plantuml.com/plantuml/png/DSmn3i8m38NXlQU02yG36rEluZeMZKZSo7cculO42QOdVTBxrm5sHAlBjPZKo1fUBplGnvt8-KoFWZss6Efo6DIGv6WaMULvSsBP651_K-DYr2lRjqO_FUUvlzAVbrKjp_q0)

When the PV system generates surplus energy, it is stored in the battery for later use. The stored energy can then be supplied to power outlets as needed. If the conversion processes are managed effectively, the overall energy balance can become positive.

## System Context

At a more conceptual level, the AC battery functions as a device for storing energy from the grid and subsequently feeding it back into the system. An external smart meter monitors the photovoltaic (PV) excess. When excess energy is detected, the battery's charger connects to the AC line to initiate charging. The charger disengages once the excess energy is no longer available. When the battery reaches full capacity or energy demand arises, the inverter connects to the AC line to discharge the stored energy. The following image illustrates the system context.

![AC Battery System Context](https://cdn-0.plantuml.com/plantuml/png/DOmx2iD030LxdoAvmAf8byfNaRKYNh8h6-c9nBVF1rmD3CpC0NRawDErcVIicjulAx37dSZvLHuDQouPwh8Pr51a6oHLvNbpObaOK3zeS3FQEzllHd44TFoBDygffrcjVla1)

The AC battery does not operate independently; rather, it is managed by battery management software hosted on a device within the same Wi-Fi network, to which both the AC battery and the smart meter are connected. The management software retrieves data from the smart meter and remotely controls the battery's charger and inverter based on the current energy conditions.

## Hardware Design

The schematics were designed with [QElectroTech](https://qelectrotech.org/). You can download the [ACBattery schematics](https://github.com/cdeck3r/acbattery/blob/main/schematics/ACSpeicher.qet) in PDF format.

{% include image-gallery.html folder="/assets/schematics" %}

### Precharge

A key component of the system is the inverter driver board, which comprises four independently controllable MOSFETs. The MOSFET on channel 1, the precharge channel, is responsible for precharging the inverter. When the inverter is activated, this MOSFET connects the battery via a circuit that limits the current to 2A, allowing the capacitors within the inverter to precharge. After a few seconds, the driver board engages the other three MOSFETs via the power channel, while the precharge channel is deactivated. At this point, the battery connects to the inverter at full load, and power is distributed across the three MOSFETs, which helps manage heat dissipation under load.

### Networked Units

The AC battery incorporates networked embedded devices for controlling and monitoring its operation:

- **Shelly Plus 1PM**: A Wi-Fi-enabled relay that manages the AC power supply to both the charger and the inverter.
- **ESP32 NodeMCU**: A microcontroller that controls the MOSFET driver board to switch DC power to the inverter and retrieves the battery's State of Charge (SoC) from the shunt.

### Operational Characteristics

The AC battery system supports charging and discharging at varying power levels.

The charger offers three manually adjustable power settings: 5A, 10A, and 20A, corresponding to power consumption rates of 60W, 120W, and 240W from the grid during charging. Although the charging power cannot be adjusted continuously, these settings provide adequate control across different seasonal variations in solar irradiance. For instance, during the summer months, the charger is typically set to its maximum level of 240W, while in winter, it is reduced to 60W in anticipation of lower solar irradiance. During spring and autumn, a setting of 120W is generally used. This heuristic approach has proven effective; however, continuous monitoring of solar irradiance could further refine this method and enhance system efficiency.

The inverter power, adjustable via software, ranges between 0 and 300W and is set based on the expected base load. In the current configuration, the system is designed to feed power into the grid during nighttime, with the inverter power set to 150W.

### Electrical and Thermal Characteristics

In the following, there are some measurements showing the AC battery's characteristics. The inverter was limited at 150W under load.

| Inverter                                     | 95% Efficiency |
| Step Up consumption with no load             | 2W             |
| Temp. Step Up (under load)                   | 38째C           |
| Inverter consumption under load, but no grid | 1.7W           |
| Temp. MOSFET (no heat sink)                  | 95째C           |
| Temp. MOSFET (with heat sink)                | 70째C           |
| Temp. MOSFET (with heat sink and fan)        | 58째C           |
 

## Battery Management Software

The software design is structured as a set of communicating [state machines](https://en.wikipedia.org/wiki/Finite-state_machine) based on the [actor model](https://en.wikipedia.org/wiki/Actor_model). The following diagram depicts the main actors and the events they exchange with each other.


![Communicating Actors](https://cdn-0.plantuml.com/plantuml/png/DOmn3i8m34NtdW8k40ziJBsAwrWq8d4g-rk8srE6Ja_l3MyDi2D7N-xDf6VLz7xRWIEUHCwVychOSyjGbsbGGv4vIAhA--74iZ6W_gN1pUZeRF_RsJ4zokNBgbPF_W00)

In this model, each actor is a state machine that maintains its own state. State transitions occur in response to events, which are received from other actors or the external environment.

The following subsections provide the design of the three primary actors.

### `bmsActor`

The `bmsActor` serves as the primary finite state machine (FSM) responsible for managing the charging and discharging operations of the battery. The following diagram depicts the actor.

![Battery Management Actor](https://cdn-0.plantuml.com/plantuml/png/DSon3G8n34RX_gQ01UA2ZkeOnN4iBY9n8kUt4Di3nLLFUiMtBx0ZUjkkrQH5qV1sEO2vxaJEx_IiE2B7KfTXK4EIqKcAoklcn98PKFzGvseq6zjVezpNGp0ydMVRrSglNm00)

Upon receiving a `PV_EXCESS` event, the system initiates the battery charging process. It will exit this state upon receiving a `PV_LOW` event. Both events are triggered by the [`pvActor` state machine](#pvactor).

The system discharges the battery when instructed to supply the household's base load and will automatically exit this state if a `PV_EXCESS` event occurs or the battery charge becomes critically low. Additionally, the state machine responds to events triggered by manual interventions that alter the system's operational state.

### `pvActor`

The `pvActor` implements a hysteresis mechanism based on the duration of periods with positive power ($P > 0$) and negative power ($P < 0$), as measured by the smart meter.

The state machine as shown in the diagram below transitions between two main states: `PV_LOW` and `PV_EXCESS`, which represent insufficient PV production and PV surplus, respectively. In the `PV_EXCESS` state, the `bmsActor` is activated to store the excess energy in the battery. When the state machine transitions to `PV_LOW`, battery charging is halted.

![PV Actor](https://cdn-0.plantuml.com/plantuml/png/DSon3G8n34RX_gQ01UA2ZkeOnUTO929n8kStYEs1Wkf9h_Zs1NP4RzkvchJ86jvE1PZhIkJyIlUA4aSiTHa6DIGPdIIhF2vEB0S3wc_gN8rcO_jfD9ytmV3q7zkkbh_z0000)

Successive measurements from the smart meter indicating negative power ($P-$) will eventually trigger a transition to the `PV_EXCESS` state, while consecutive measurements of positive power ($P+$) will result in a transition to the `PV_LOW` state. The parameters $a$ and $b$ define the time thresholds for the hysteresis curve that governs these transitions.

The smart meter identifies the $P-$ condition, signifying a PV surplus, and generates the corresponding event when the PV system produces more power than the household's consumption plus the charging power specified by the charger's power setting (see [section on operational characteristics](#operational-characteristics)). If this condition is not met, the meter registers a $P+$ condition emitting the correspondig event.

The `pvActor` functions analogously to a (non-linear) low-pass filter, effectively filtering out intermittent fluctuations between $P-$ and $P+$ measurements. It accepts more stable measurements of $P-$ or $P+$ as events that trigger a state transition to `PV_EXCESS` or `PV_LOW`, respectively.

The output of the `pvActor` yields a `PV_EXCESS` state if, for a series of successive $P-$ measurement events, $t_0(P-) < ... < t_n(P-)$, the duration $\Delta t(P-) = t_n(P-) - t_0(P-) \geq a$. The parameter $a$ can be interpreted as a variant of a time constant, $a = \tau(P-)$, which represents the actor's response time to _successive_ $P-$ measurements for a _minimum_ duration of $a$. It should be noted that the concept of the time constant is constrained in this context, as indicated by the emphasis on key conditions.

Similarly, $b = \tau(P+)$ defines the actor's time constant for its response to the `PV_LOW` state based on $P+$ measurements.

### `invDrvActor`

This actor is a state machine that manages the precharge behavior through the MOSFET driver board, as previously detailed in section [Precharge](#precharge). The following diagram depicts the actor.

![Inverter Driver Actor](https://cdn-0.plantuml.com/plantuml/png/DSmn3i8m34RXlQU02yG36rEHk8ZhM3GYSIhdTn2t1mQc9xtXMmVO4Qqkvs9I8sjuFUt0CQv4pg_qADXZYw4ktQ269BsHP9NdnObbOq3zJOsBqL7PVXeLctUVDq7tz9_BgfQ__G00)

## Software Deployment

The following UML deployment diagram illustrates the distribution of various software components for the AC battery system, which are hosted across multiple Raspberry Pi devices.

![Deployed Software Components for the AC Battery System](https://cdn-0.plantuml.com/plantuml/png/DOonhSCm30LxJ_7_0cQHBfLNeIaY5a9H0lK8mzidBb8TSC3TDi61RBRyLnVBeXdsTm1ZFec2p_LLSUIUKqEwGnshz4PILDwF89QT0OsB6bUdOUptZUPPT5Y_sXtyxBAfboy_)

The AC battery system requires real-time power measurements from an electricity meter that monitors both AC loads and photovoltaic (PV) energy surplus. The [vzlogger](https://github.com/volkszaehler/vzlogger) software, installed on a Raspberry Pi, connects to the electricity meter using the [SML protocol](https://de.wikipedia.org/wiki/Smart_Message_Language). 

The system employs several networked controllers to operate relays that connect the AC network to the battery for charging and discharging purposes. Each controller includes its own web-based graphical user interface (WebGUI), allowing for manual control of individual components. This feature is primarily intended for developers.

The battery management actors operate within a Node-RED environment hosted on a Raspberry Pi-based home server. All devices are connected to a home Wi-Fi network and communicate using the [MQTT](https://en.wikipedia.org/wiki/MQTT) protocol to a broker running on the home server. 

A dashboard provides users with insights into the current operation of the system. Notably, there is no remote access available from outside the home network.

## Contact

If you are having any suggestions, feel free to [file a GitHub issue](https://github.com/cdeck3r/acbattery/issues/new).


